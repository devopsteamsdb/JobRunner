{% extends "base.html" %}
{% block title %}{{ job.name }} - Job Scheduler{% endblock %}

{% block header %}
<div class="header-with-actions">
    <div>
        <h2>{{ job.name }}</h2>
        <p class="header-subtitle">
            <span class="job-type-badge {{ job.job_type }}">{{ job.job_type }}</span>
            <span class="status-badge {{ job.status }}">{{ job.status }}</span>
        </p>
    </div>
    <div class="header-actions">
        <button class="btn btn-primary" onclick="runJob({{ job.id }})">Run Now</button>
        <a href="{{ url_for('views.job_form_edit', job_id=job.id) }}" class="btn btn-secondary">Edit</a>
    </div>
</div>
{% endblock %}

{% block content %}
<div class="job-detail-grid">
    <div class="info-panel">
        <h3>Job Details</h3>
        <div class="info-item"><label>Description</label>
            <p>{{ job.description or 'No description' }}</p>
        </div>
        <div class="info-item"><label>Schedule</label>
            <p><code>{{ job.cron_expression or 'Not set' }}</code></p>
        </div>
        <div class="info-item"><label>Last Run</label>
            <p>{{ job.last_run.strftime('%Y-%m-%d %H:%M:%S') if job.last_run else 'Never' }}</p>
        </div>
        <div class="info-item"><label>Next Run</label>
            <p>{{ job.next_run.strftime('%Y-%m-%d %H:%M:%S') if job.next_run else 'N/A' }}</p>
        </div>
    </div>

    <div class="console-panel">
        <div class="console-header">
            <h3>Live Console</h3>
            <span class="connection-status" id="connection-status">Connecting...</span>
        </div>
        <div class="console-output" id="console-output">
            <div class="console-placeholder">Waiting for job output...</div>
        </div>
    </div>
</div>

<section class="history-section">
    <h3>Execution History</h3>
    <div class="table-container">
        <table class="data-table">
            <thead>
                <tr>
                    <th>Started</th>
                    <th>Status</th>
                    <th>Exit Code</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for log in logs %}
                <tr>
                    <td>{{ log.started_at.strftime('%Y-%m-%d %H:%M:%S') }}</td>
                    <td><span class="status-badge {{ log.status }}">{{ log.status }}</span></td>
                    <td>{{ log.exit_code if log.exit_code is not none else '-' }}</td>
                    <td><button class="btn btn-sm" onclick="viewLog({{ log.id }})">View</button></td>
                </tr>
                {% else %}
                <tr>
                    <td colspan="4">No history yet</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</section>

<div class="modal" id="log-modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Log Output</h3><button onclick="closeModal()">&times;</button>
        </div>
        <pre id="log-output" class="log-viewer"></pre>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
    const jobId = {{ job.id }};
    const socket = io('/jobs');

    socket.on('connect', () => {
        console.log('Connected to job detail updates');
        document.getElementById('connection-status').textContent = 'Connected';
        socket.emit('subscribe', { job_id: jobId });
    });

    // Use job_update for clean status updates
    socket.on('job_update', (data) => {
        if (data.job_id === jobId) {
            console.log('Status update:', data.status);

            // Update Header Status Badge
            const statusBadge = document.querySelector('.header-subtitle .status-badge');
            if (statusBadge) {
                statusBadge.className = `status-badge ${data.status}`;
                statusBadge.textContent = data.status;
            }

            // Update Last Run/Next Run in Info Panel
            if (data.last_run) {
                const infoItems = document.querySelectorAll('.info-panel .info-item p');
                // Assuming order: Description, Schedule, Last Run, Next Run
                // Last Run is index 2
                if (infoItems[2]) infoItems[2].textContent = data.last_run.replace('T', ' ');
            }
            if (data.next_run) {
                const infoItems = document.querySelectorAll('.info-panel .info-item p');
                // Next Run is index 3
                if (infoItems[3]) infoItems[3].textContent = data.next_run.replace('T', ' ');
            }

            // Refresh history table when status changes to running or success/failed
            // We can debounce this or just call it, network traffic is low
            updateJobHistory();
        }
    });

    socket.on('job_log', (data) => {
        if (data.job_id === jobId) {
            const consoleOutput = document.getElementById('console-output');
            const ph = consoleOutput.querySelector('.console-placeholder');
            if (ph) ph.remove();

            const line = document.createElement('div');
            line.className = 'console-line';
            line.textContent = data.message;
            consoleOutput.appendChild(line);
            consoleOutput.scrollTop = consoleOutput.scrollHeight;
        }
    });

    socket.on('job_complete', (data) => {
        if (data.job_id === jobId) {
            // Add separator to console
            const consoleOutput = document.getElementById('console-output');
            const separator = document.createElement('div');
            separator.className = 'console-separator';
            separator.style.borderTop = '1px dashed #666';
            separator.style.margin = '10px 0';
            separator.style.padding = '5px 0';
            separator.textContent = `--- Execution finished at ${data.timestamp} ---`;
            consoleOutput.appendChild(separator);
            consoleOutput.scrollTop = consoleOutput.scrollHeight;

            // Final refresh of history to get exit codes
            setTimeout(updateJobHistory, 500);
        }
    });

    async function updateJobHistory() {
        try {
            const res = await fetch(`/api/jobs/${jobId}/logs?per_page=10`);
            if (res.ok) {
                const data = await res.json();
                const tbody = document.querySelector('.data-table tbody');
                if (tbody && data.logs.length > 0) {
                    tbody.innerHTML = data.logs.map(log => `
                        <tr>
                            <td>${log.started_at.replace('T', ' ')}</td>
                            <td><span class="status-badge ${log.status}">${log.status}</span></td>
                            <td>${log.exit_code != null ? log.exit_code : '-'}</td>
                            <td><button class="btn btn-sm" onclick="viewLog(${log.id})">View</button></td>
                        </tr>
                    `).join('');
                }
            }
        } catch (e) {
            console.error('Failed to update history:', e);
        }
    }

    async function runJob(id) {
        const res = await fetch(`/api/jobs/${id}/run`, { method: 'POST' });
        if (res.ok) {
            showToast('Job triggered', 'success');
            // Status update will handle the rest via socket
        } else {
            const data = await res.json();
            showToast(data.error || 'Failed', 'error');
        }
    }

    async function viewLog(logId) {
        const res = await fetch(`/api/logs/${logId}`);
        const data = await res.json();
        const logContent = document.getElementById('log-output');
        logContent.textContent = data.output || 'No output';

        // Append error output if exists
        if (data.error_output) {
            const errDiv = document.createElement('div');
            errDiv.style.color = 'var(--status-failed)';
            errDiv.style.marginTop = '1em';
            errDiv.style.borderTop = '1px solid #333';
            errDiv.style.paddingTop = '1em';
            errDiv.textContent = 'ERROR OUTPUT:\n' + data.error_output;
            logContent.appendChild(errDiv);
        }

        document.getElementById('log-modal').classList.add('active');
    }

    function closeModal() {
        document.getElementById('log-modal').classList.remove('active');
    }
</script>
{% endblock %}