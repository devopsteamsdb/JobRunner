{% extends "base.html" %}

{% block title %}Dashboard - Job Scheduler{% endblock %}

{% block header %}
<h2>Dashboard</h2>
<p class="header-subtitle">Overview of your scheduled jobs</p>
{% endblock %}

{% block content %}
<!-- Stats Cards -->
<div class="stats-grid">
    <div class="stat-card">
        <div class="stat-icon blue">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path
                    d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 1 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z" />
            </svg>
        </div>
        <div class="stat-content">
            <span class="stat-value">{{ total_jobs }}</span>
            <span class="stat-label">Total Jobs</span>
        </div>
    </div>

    <div class="stat-card">
        <div class="stat-icon green">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="20,6 9,17 4,12" />
            </svg>
        </div>
        <div class="stat-content">
            <span class="stat-value">{{ enabled_jobs }}</span>
            <span class="stat-label">Active Jobs</span>
        </div>
    </div>

    <div class="stat-card">
        <div class="stat-icon cyan">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="22,12 18,12 15,21 9,3 6,12 2,12" />
            </svg>
        </div>
        <div class="stat-content">
            <span class="stat-value">{{ success_count }}</span>
            <span class="stat-label">Successful Runs</span>
        </div>
    </div>

    <div class="stat-card">
        <div class="stat-icon red">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="10" />
                <line x1="15" y1="9" x2="9" y2="15" />
                <line x1="9" y1="9" x2="15" y2="15" />
            </svg>
        </div>
        <div class="stat-content">
            <span class="stat-value">{{ failed_count }}</span>
            <span class="stat-label">Failed Runs</span>
        </div>
    </div>
</div>

<!-- Running Jobs Section -->
<section class="dashboard-section">
    <div class="section-header">
        <h3>
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polygon points="5,3 19,12 5,21 5,3" />
            </svg>
            Running Jobs
        </h3>
        <span class="badge">{{ running_jobs|length }}</span>
    </div>

    <div class="running-jobs-container" id="running-jobs">
        {% if running_jobs %}
        {% for job in running_jobs %}
        <div class="job-card running" data-job-id="{{ job.id }}">
            <div class="job-card-header">
                <span class="job-type-badge {{ job.job_type }}">{{ job.job_type }}</span>
                <span class="job-status running">
                    <span class="spinner"></span>
                    Running
                </span>
            </div>
            <h4 class="job-name">{{ job.name }}</h4>
            <p class="job-description">{{ job.description or 'No description' }}</p>
            <div class="job-meta">
                <span>Started: {{ job.last_run.strftime('%H:%M:%S') if job.last_run else 'N/A' }}</span>
            </div>
            <div class="job-actions">
                <a href="{{ url_for('views.job_detail', job_id=job.id) }}" class="btn btn-sm btn-secondary">
                    View Logs
                </a>
            </div>
        </div>
        {% endfor %}
        {% else %}
        <div class="empty-state">
            <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1">
                <circle cx="12" cy="12" r="10" />
                <line x1="12" y1="8" x2="12" y2="12" />
                <line x1="12" y1="16" x2="12.01" y2="16" />
            </svg>
            <p>No jobs currently running</p>
        </div>
        {% endif %}
    </div>
</section>

<!-- Recent Activity Section -->
<section class="dashboard-section">
    <div class="section-header">
        <h3>
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="10" />
                <polyline points="12,6 12,12 16,14" />
            </svg>
            Recent Activity
        </h3>
    </div>

    <div class="activity-list">
        {% if recent_logs %}
        {% for log in recent_logs %}
        <div class="activity-item">
            <div class="activity-status {{ log.status }}">
                {% if log.status == 'success' %}
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="20,6 9,17 4,12" />
                </svg>
                {% elif log.status == 'failed' %}
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="18" y1="6" x2="6" y2="18" />
                    <line x1="6" y1="6" x2="18" y2="18" />
                </svg>
                {% elif log.status == 'running' %}
                <span class="spinner small"></span>
                {% else %}
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="10" />
                </svg>
                {% endif %}
            </div>
            <div class="activity-content">
                <span class="activity-job">{{ log.job.name }}</span>
                <span class="activity-time">{{ log.started_at.strftime('%Y-%m-%d %H:%M:%S') }}</span>
            </div>
            <div class="activity-meta">
                <span class="activity-trigger {{ log.trigger_type }}">{{ log.trigger_type }}</span>
                {% if log.exit_code is not none %}
                <span class="activity-exit-code {{ 'success' if log.exit_code == 0 else 'error' }}">
                    Exit: {{ log.exit_code }}
                </span>
                {% endif %}
            </div>
        </div>
        {% endfor %}
        {% else %}
        <div class="empty-state small">
            <p>No recent activity</p>
        </div>
        {% endif %}
    </div>
</section>
{% endblock %}

{% block extra_scripts %}
<script>
    // Connect to WebSocket for real-time updates
    const socket = io('/jobs');

    socket.on('connect', function () {
        console.log('Connected to job updates');
        // Refresh data on connection/reconnection to ensure sync
        updateRecentActivity();
        updateStats();
        // Clear running jobs list and let it rebuild if needed, or fetch running API
        fetch('/api/jobs/running')
            .then(res => res.json())
            .then(jobs => {
                // Clear current list logic or merge?
                // Simplest is to clear and rebuild if we want to be sure
                const container = document.getElementById('running-jobs');
                // We won't clear immediately to avoid flash, but we should reconcile
                // For simplicity, let's just create cards for any that are missing
                jobs.forEach(job => {
                    updateRunningJobs({ job_id: job.id, status: 'running' });
                });
            });
    });

    socket.on('job_update', function (data) {
        console.log('Job Update:', data);
        updateRunningJobs(data);
        // Refresh recent activity/stats on any update to be safe and unresponsive
        if (data.status === 'running' || data.status === 'success' || data.status === 'failed') {
            updateRecentActivity();
            updateStats();
        }
    });

    // Fallback polling: sync every 5 seconds in case socket events are missed
    setInterval(() => {
        fetch('/api/jobs/running')
            .then(res => res.json())
            .then(jobs => {
                const container = document.getElementById('running-jobs');
                const currentCards = container.querySelectorAll('.job-card');
                const serverJobIds = new Set(jobs.map(j => j.id));

                // Update all running/queued jobs (adds new ones and updates existing)
                jobs.forEach(job => {
                    updateRunningJobs({ job_id: job.id, status: job.status });
                });

                // Remove jobs that are no longer running/queued
                currentCards.forEach(card => {
                    const jobId = parseInt(card.dataset.jobId);
                    if (!serverJobIds.has(jobId)) {
                        card.remove();
                        updateRunningCount();
                    }
                });

                // Show empty state if needed
                if (container.children.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1">
                                <circle cx="12" cy="12" r="10" />
                                <line x1="12" y1="8" x2="12" y2="12" />
                                <line x1="12" y1="16" x2="12.01" y2="16" />
                            </svg>
                            <p>No jobs currently running</p>
                        </div>
                    `;
                }
            })
            .catch(e => console.error('Polling failed:', e));

        // Also refresh recent activity
        updateRecentActivity();
    }, 2000);

    function updateRunningJobs(data) {
        const container = document.getElementById('running-jobs');
        const existingCard = container.querySelector(`.job-card[data-job-id="${data.job_id}"]`);

        if (data.status === 'running' || data.status === 'queued') {
            if (!existingCard) {
                // Fetch job details to create card if it doesn't exist
                fetch(`/api/jobs/${data.job_id}`)
                    .then(res => res.json())
                    .then(job => {
                        // Check again in case it was added while fetching
                        if (container.querySelector(`.job-card[data-job-id="${data.job_id}"]`)) return;

                        const emptyState = container.querySelector('.empty-state');
                        if (emptyState) emptyState.remove();

                        const card = document.createElement('div');
                        card.className = `job-card ${data.status}`;
                        card.dataset.jobId = job.id;

                        const statusHtml = data.status === 'running'
                            ? `<span class="spinner"></span> Running`
                            : `<span class="status-icon">⏳</span> Queued`;

                        card.innerHTML = `
                            <div class="job-card-header">
                                <span class="job-type-badge ${job.job_type}">${job.job_type}</span>
                                <span class="job-status ${data.status}">
                                    ${statusHtml}
                                </span>
                            </div>
                            <h4 class="job-name">${job.name}</h4>
                            <p class="job-description">${job.description || 'No description'}</p>
                            <div class="job-meta">
                                <span>Started: ${new Date().toLocaleTimeString('en-GB')}</span>
                            </div>
                            <div class="job-actions">
                                <a href="/jobs/${job.id}" class="btn btn-sm btn-secondary">
                                    View Logs
                                </a>
                            </div>
                        `;
                        container.appendChild(card);
                        updateRunningCount();
                    });
            } else {
                // Update existing card status
                const statusBadge = existingCard.querySelector('.job-status');
                existingCard.className = `job-card ${data.status}`;
                if (statusBadge) {
                    statusBadge.className = `job-status ${data.status}`;
                    statusBadge.innerHTML = data.status === 'running'
                        ? `<span class="spinner"></span> Running`
                        : `<span class="status-icon">⏳</span> Queued`;
                }
            }
        } else {
            // If not running (success, failed, queued, idle), remove from running list
            if (existingCard) {
                existingCard.remove();
                if (container.children.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1">
                                <circle cx="12" cy="12" r="10" />
                                <line x1="12" y1="8" x2="12" y2="12" />
                                <line x1="12" y1="16" x2="12.01" y2="16" />
                            </svg>
                            <p>No jobs currently running</p>
                        </div>
                    `;
                }
                updateRunningCount();
            }
        }
    }

    function updateRunningCount() {
        const count = document.querySelectorAll('#running-jobs .job-card').length;
        const badge = document.querySelector('.section-header .badge');
        if (badge) badge.textContent = count;
    }

    async function updateRecentActivity() {
        try {
            const res = await fetch('/api/logs/recent?limit=10');
            if (res.ok) {
                const logs = await res.json();
                const container = document.querySelector('.activity-list');
                if (logs.length === 0) {
                    container.innerHTML = '<div class="empty-state small"><p>No recent activity</p></div>';
                    return;
                }

                container.innerHTML = logs.map(log => {
                    let icon = '';
                    if (log.status === 'success') {
                        icon = '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20,6 9,17 4,12" /></svg>';
                    } else if (log.status === 'failed') {
                        icon = '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18" /><line x1="6" y1="6" x2="18" y2="18" /></svg>';
                    } else if (log.status === 'running') {
                        icon = '<span class="spinner small"></span>';
                    } else {
                        icon = '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10" /></svg>';
                    }

                    return `
                        <div class="activity-item">
                            <div class="activity-status ${log.status}">
                                ${icon}
                            </div>
                            <div class="activity-content">
                                <span class="activity-job">${log.job_name}</span>
                                <span class="activity-time">${log.started_at.replace('T', ' ')}</span>
                            </div>
                            <div class="activity-meta">
                                <span class="activity-trigger ${log.trigger_type}">${log.trigger_type}</span>
                                ${log.exit_code !== null ? `<span class="activity-exit-code ${log.exit_code === 0 ? 'success' : 'error'}">Exit: ${log.exit_code}</span>` : ''}
                            </div>
                        </div>
                    `;
                }).join('');
            }
        } catch (e) {
            console.error('Failed to update recent activity:', e);
        }
    }

    async function updateStats() {
        // We could create a specific API for stats, or just reload page if crucial. 
        // For now, let's assume stats (top cards) are less critical to be instant-update than lists.
        // But for "Running Jobs" count, we updated it manually.
        // We can create a simple stats endpoint or just leave it for page load.
    }
</script>
{% endblock %}