{% extends "base.html" %}

{% block title %}File Manager - Job Scheduler{% endblock %}

{% block header %}
<div class="header-with-actions">
    <div>
        <h2>File Manager</h2>
        <p class="header-subtitle">Manage scripts, playbooks, and inventory files</p>
    </div>
    <div class="actions">
        <button class="btn btn-primary" onclick="createNew('file')">New File</button>
        <button class="btn btn-secondary" onclick="createNew('directory')">New Folder</button>
        <div class="divider-vertical"
            style="display:inline-block; width:1px; height:24px; background:var(--border-color); margin:0 8px; vertical-align:middle;">
        </div>

        <button class="btn btn-secondary" onclick="document.getElementById('upload-files').click()"
            title="Drag & Drop files/folders also supported">Upload Files</button>
        <button class="btn btn-secondary" onclick="document.getElementById('upload-folder').click()"
            title="Drag & Drop files/folders also supported">Upload Folder</button>

        <input type="file" id="upload-files" multiple style="display:none" onchange="handleUpload(this.files)">
        <input type="file" id="upload-folder" webkitdirectory directory multiple style="display:none"
            onchange="handleUpload(this.files)">
    </div>
</div>
{% endblock %}

{% block content %}
<div class="file-manager-container">
    <div class="file-sidebar">
        <div class="file-tree" id="file-tree">
            <!-- Tree content loading... -->
            <div class="loading-spinner">Loading...</div>
        </div>
    </div>
    <div class="file-editor-pane">
        <div class="editor-toolbar" id="editor-toolbar" style="display:none;">
            <span class="file-path" id="current-file-path"></span>
            <div class="editor-actions">
                <button class="btn btn-sm btn-primary" onclick="saveFile()">Save</button>
                <button class="btn btn-sm btn-danger" onclick="deleteCurrentItem()">Delete</button>
            </div>
        </div>
        <div class="empty-state" id="empty-state">
            <p>Select a file to view or edit</p>
        </div>
        <div class="editor-wrapper" id="editor-wrapper" style="display:none;">
            <div id="monaco-editor-container" style="width:100%;height:100%;"></div>
        </div>
    </div>
</div>

<style>
    .file-manager-container {
        display: flex;
        height: calc(100vh - 200px);
        background: var(--card-bg);
        border: 1px solid var(--border-color);
        border-radius: 8px;
        overflow: hidden;
    }

    .file-sidebar {
        width: 300px;
        border-right: 1px solid var(--border-color);
        background: var(--bg-secondary);
        overflow-y: auto;
        padding: 1rem;
    }

    .file-tree-item {
        cursor: pointer;
        padding: 4px 8px;
        border-radius: 4px;
        display: flex;
        align-items: center;
        gap: 8px;
        color: var(--text-secondary);
    }

    .file-tree-item:hover {
        background: var(--hover-bg);
        color: var(--text-primary);
    }

    .file-tree-item.active {
        background: var(--primary-color-dim);
        color: var(--primary-color);
        font-weight: 500;
        border-left: 3px solid var(--primary-color);
    }

    .file-tree-item.directory.active {
        background: rgba(var(--primary-rgb), 0.15);
        /* Slightly darker/more visible than dim */
        font-weight: 700;
    }

    .file-tree-item.directory {
        font-weight: 500;
    }

    .file-tree-children {
        margin-left: 20px;
        border-left: 1px solid var(--border-color);
    }

    .file-editor-pane {
        flex: 1;
        display: flex;
        flex-direction: column;
        background: var(--card-bg);
    }

    .editor-toolbar {
        padding: 0.5rem 1rem;
        border-bottom: 1px solid var(--border-color);
        display: flex;
        justify-content: space-between;
        align-items: center;
        background: var(--bg-secondary);
    }

    .file-path {
        font-family: monospace;
        font-weight: 600;
    }

    .editor-wrapper {
        flex: 1;
        position: relative;
        overflow: hidden;
        /* Important for Monaco */
    }

    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--text-muted);
    }

    /* Dropdown Styles */
    .dropdown {
        position: relative;
        display: inline-block;
    }
</style>

<!-- Load Monaco Editor -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.44.0/min/vs/loader.min.js"></script>

{% endblock %}

{% block extra_scripts %}
<script>
    let currentPath = null;
    let currentDirectory = null;
    let editor = null;
    let expandedPaths = new Set();

    // Initialize Monaco Editor
    require.config({ paths: { 'vs': 'https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.44.0/min/vs' } });

    require(['vs/editor/editor.main'], function () {
        editor = monaco.editor.create(document.getElementById('monaco-editor-container'), {
            value: '',
            language: 'plaintext',
            theme: 'vs-dark', // or 'vs' based on preference, 'vs-dark' matches typical tech vibe
            automaticLayout: true,
            minimap: { enabled: false },
            fontSize: 14,
            fontFamily: "'Fira Code', Consolas, 'Courier New', monospace"
        });

        // Handle theme based on CSS variables if possible, or just default to dark for now
    });

    function selectRoot() {
        currentDirectory = null;
        currentPath = null;
        document.querySelectorAll('.file-tree-item').forEach(el => el.classList.remove('active'));
        // Also remove specific active class from root-item if it exists (it's re-rendered)
        const rootItem = document.querySelector('.root-item');
        if (rootItem) rootItem.classList.add('active');

        // Reset UI
        document.getElementById('editor-toolbar').style.display = 'none';
        document.getElementById('editor-wrapper').style.display = 'none';
        document.getElementById('empty-state').style.display = 'flex';
        document.querySelector('#empty-state p').textContent = 'Select a file to view or edit';

        console.log('Current context: Root');
    }

    async function loadFileTree() {
        const response = await fetch('/api/files/tree');
        const treeData = await response.json();
        const treeRoot = document.getElementById('file-tree');
        treeRoot.innerHTML = '';

        // Add explicit Root node
        const rootDiv = document.createElement('div');
        const rootItem = document.createElement('div');
        rootItem.className = 'file-tree-item directory root-item';

        // Check if root should be active (when currentDirectory is null)
        if (!currentDirectory) {
            rootItem.classList.add('active');
        }

        rootItem.innerHTML = `
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
                <polyline points="9 22 9 12 15 12 15 22"></polyline>
            </svg>
            <span>Root</span>
        `;
        rootItem.onclick = () => selectRoot();
        rootDiv.appendChild(rootItem);
        treeRoot.appendChild(rootDiv);

        renderTree(treeData, treeRoot);
    }

    function renderTree(items, container) {
        items.forEach(item => {
            const el = document.createElement('div');

            const itemEl = document.createElement('div');
            itemEl.className = `file-tree-item ${item.type}`;
            itemEl.dataset.path = item.path; // Store path for selection logic
            itemEl.innerHTML = `
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    ${item.type === 'directory'
                    ? '<path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path>'
                    : '<path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"></path><polyline points="13 2 13 9 20 9"></polyline>'}
                </svg>
                <span>${item.name}</span>
            `;

            // Restore active state
            if (item.type === 'directory' && currentDirectory === item.path) {
                itemEl.classList.add('active');
            } else if (item.type === 'file' && currentPath === item.path) {
                itemEl.classList.add('active');
            }

            itemEl.onclick = (e) => {
                e.stopPropagation();

                // Clear all active states first
                document.querySelectorAll('.file-tree-item').forEach(el => el.classList.remove('active'));
                itemEl.classList.add('active');

                if (item.type === 'file') {
                    // Check if we are in picker mode
                    const urlParams = new URLSearchParams(window.location.search);
                    if (urlParams.get('mode') === 'picker') {
                        if (window.opener) {
                            window.opener.postMessage({
                                type: 'fileSelected',
                                path: item.path
                            }, '*');
                            window.close();
                        }
                        return;
                    }

                    openFile(item.path);
                    currentDirectory = item.path.substring(0, item.path.lastIndexOf('/'));
                    if (currentDirectory === item.path) currentDirectory = '';

                    // Specific UI state for files
                    document.querySelector('.editor-actions .btn-primary').style.display = 'inline-block'; // Show Save
                    document.querySelector('.editor-actions .btn-danger').textContent = 'Delete File'; // Reset text
                    document.getElementById('empty-state').style.display = 'none';
                } else {
                    // Set current directory
                    currentDirectory = item.path;

                    // Allow deletion of folders
                    currentPath = item.path;
                    document.getElementById('current-file-path').textContent = item.path;
                    document.getElementById('editor-toolbar').style.display = 'flex';
                    document.querySelector('.editor-actions .btn-primary').style.display = 'none'; // Hide Save
                    document.querySelector('.editor-actions .btn-danger').textContent = 'Delete Folder'; // Explicit text
                    document.getElementById('editor-wrapper').style.display = 'none';
                    document.getElementById('empty-state').style.display = 'flex';
                    document.querySelector('#empty-state p').textContent = `Folder selected: ${item.name}`;

                    // Toggle folder expansion
                    const children = el.querySelector('.file-tree-children');
                    if (children) {
                        const isHidden = children.style.display === 'none';
                        children.style.display = isHidden ? 'block' : 'none';

                        if (isHidden) {
                            expandedPaths.add(item.path);
                        } else {
                            expandedPaths.delete(item.path);
                        }
                    }
                }
                console.log('Current context:', currentDirectory || 'Root');
            };

            el.appendChild(itemEl);

            if (item.children) {
                const childrenContainer = document.createElement('div');
                childrenContainer.className = 'file-tree-children';

                // Restore expansion state
                if (expandedPaths.has(item.path)) {
                    childrenContainer.style.display = 'block';
                } else {
                    childrenContainer.style.display = 'none';
                }

                renderTree(item.children, childrenContainer);
                el.appendChild(childrenContainer);
            }

            container.appendChild(el);
        });
    }

    function getLanguageFromPath(path) {
        const ext = path.split('.').pop().toLowerCase();
        const map = {
            'js': 'javascript',
            'py': 'python',
            'sh': 'shell',
            'bash': 'shell',
            'yml': 'yaml',
            'yaml': 'yaml',
            'json': 'json',
            'html': 'html',
            'css': 'css',
            'md': 'markdown',
            'ps1': 'powershell',
            'sql': 'sql',
            'xml': 'xml'
        };
        return map[ext] || 'plaintext';
    }

    async function openFile(path) {
        currentPath = path;
        document.getElementById('current-file-path').textContent = path;
        document.getElementById('empty-state').style.display = 'none';
        document.getElementById('editor-wrapper').style.display = 'block';
        document.getElementById('editor-toolbar').style.display = 'flex';

        try {
            const response = await fetch(`/api/files/content?path=${encodeURIComponent(path)}`);
            const data = await response.json();
            if (data.error) throw new Error(data.error);

            if (editor) {
                const model = editor.getModel();
                monaco.editor.setModelLanguage(model, getLanguageFromPath(path));
                editor.setValue(data.content);
                // Reset scroll
                editor.revealLine(1);
            }
        } catch (e) {
            alert('Error loading file: ' + e.message);
        }
    }

    async function saveFile() {
        if (!currentPath || !editor) return;

        const content = editor.getValue();
        try {
            const response = await fetch('/api/files/content', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ path: currentPath, content })
            });
            const data = await response.json();
            if (data.error) throw new Error(data.error);

            // Simple toast notification could go here
            const btn = document.querySelector('.editor-actions .btn-primary');
            const originalText = btn.textContent;
            btn.textContent = 'Saved!';
            setTimeout(() => btn.textContent = originalText, 2000);
        } catch (e) {
            alert('Error saving file: ' + e.message);
        }
    }

    async function createNew(type) {
        let promptMsg = `Enter name for new ${type}`;
        if (currentDirectory) {
            promptMsg += ` in '${currentDirectory}'`;
        }
        promptMsg += ':';

        const name = prompt(promptMsg);
        if (!name) return;

        let path = name;
        if (currentDirectory) {
            path = `${currentDirectory}/${name}`;
        }

        try {
            const response = await fetch('/api/files/create', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    path: path,
                    is_directory: type === 'directory'
                })
            });
            const data = await response.json();
            if (data.error) throw new Error(data.error);

            loadFileTree();
        } catch (e) {
            alert('Error creating item: ' + e.message);
        }
    }

    async function handleUpload(files) {
        if (!files || files.length === 0) return;

        const formData = new FormData();
        for (let i = 0; i < files.length; i++) {
            formData.append('files[]', files[i]);
        }

        if (currentDirectory) {
            formData.append('target_path', currentDirectory);
        }

        // Reset inputs
        document.getElementById('upload-files').value = '';
        document.getElementById('upload-folder').value = '';

        try {
            // Loading state
            const originalText = document.querySelector('.header-with-actions h2').textContent;
            document.querySelector('.header-with-actions h2').textContent = 'Uploading...';

            const response = await fetch('/api/files/upload', {
                method: 'POST',
                body: formData
            });
            const data = await response.json();

            document.querySelector('.header-with-actions h2').textContent = originalText;

            if (data.error) throw new Error(data.error);

            let message = `Successfully uploaded ${data.count} files.`;
            if (data.errors && data.errors.length > 0) {
                message += '\nErrors:\n' + data.errors.join('\n');
            }
            alert(message);
            loadFileTree();
        } catch (e) {
            alert('Error uploading: ' + e.message);
        }
    }

    async function deleteCurrentItem() {
        if (!currentPath || !confirm(`Are you sure you want to delete ${currentPath}?`)) return;

        try {
            const response = await fetch('/api/files/delete', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ path: currentPath })
            });
            const data = await response.json();
            if (data.error) throw new Error(data.error);

            currentPath = null;
            if (editor) editor.setValue('');
            document.getElementById('empty-state').style.display = 'flex';
            document.getElementById('editor-wrapper').style.display = 'none';
            document.getElementById('editor-toolbar').style.display = 'none';
            loadFileTree();
        } catch (e) {
            alert('Error deleting item: ' + e.message);
        }
    }

    document.addEventListener('DOMContentLoaded', loadFileTree);

    // Ctrl+S to save
    document.addEventListener('keydown', function (e) {
        if ((e.ctrlKey || e.metaKey) && e.key === 's') {
            e.preventDefault();
            saveFile();
        }
    });

    // Handle window resize for editor
    window.addEventListener('resize', () => {
        if (editor) editor.layout();
    });

    // Drag and Drop Logic
    const dropArea = document.querySelector('.file-manager-container');
    const dragOverlay = document.createElement('div');
    dragOverlay.className = 'drag-overlay';
    dragOverlay.innerHTML = '<div class="drag-message">Drop to upload files and folders</div>';
    dropArea.appendChild(dragOverlay);

    let dragCounter = 0;

    dropArea.addEventListener('dragenter', (e) => {
        e.preventDefault();
        e.stopPropagation();
        dragCounter++;
        if (dragCounter === 1) {
            dragOverlay.classList.add('active');
        }
    });

    dropArea.addEventListener('dragleave', (e) => {
        e.preventDefault();
        e.stopPropagation();
        dragCounter--;
        if (dragCounter === 0) {
            dragOverlay.classList.remove('active');
        }
    });

    dropArea.addEventListener('dragover', (e) => {
        e.preventDefault();
        e.stopPropagation();
    });

    dropArea.addEventListener('drop', async (e) => {
        e.preventDefault();
        e.stopPropagation();
        dragCounter = 0;
        dragOverlay.classList.remove('active');

        const items = e.dataTransfer.items;
        if (!items || items.length === 0) return;

        // Show loading
        const originalText = document.querySelector('.header-with-actions h2').textContent;
        document.querySelector('.header-with-actions h2').textContent = 'Processing files...';

        try {
            const formData = new FormData();
            if (currentDirectory) {
                formData.append('target_path', currentDirectory);
            }

            const entries = [];
            for (let i = 0; i < items.length; i++) {
                const entry = items[i].webkitGetAsEntry ? items[i].webkitGetAsEntry() : items[i].getAsEntry();
                if (entry) entries.push(entry);
            }

            const files = await scanFiles(entries);

            if (files.length === 0) {
                document.querySelector('.header-with-actions h2').textContent = originalText;
                return;
            }

            document.querySelector('.header-with-actions h2').textContent = `Uploading ${files.length} items...`;

            for (const { file, path } of files) {
                // We define specific filename in the append to preserve relative path structure
                // path includes the file name
                formData.append('files[]', file, path);
            }

            const response = await fetch('/api/files/upload', {
                method: 'POST',
                body: formData
            });
            const data = await response.json();

            document.querySelector('.header-with-actions h2').textContent = originalText;

            if (data.error) throw new Error(data.error);

            let message = `Successfully uploaded ${data.count} items.`;
            if (data.errors && data.errors.length > 0) {
                message += '\nErrors:\n' + data.errors.join('\n');
            }
            alert(message);
            loadFileTree();

        } catch (e) {
            document.querySelector('.header-with-actions h2').textContent = originalText;
            alert('Error processing drop: ' + e.message);
        }
    });

    async function scanFiles(entries) {
        const result = [];

        async function readEntry(entry, path = '') {
            if (entry.isFile) {
                const file = await new Promise((resolve, reject) => entry.file(resolve, reject));
                // If path is empty, it's a root file, just use name. 
                // If path has content, join it.
                // Actually, entries from drop are root level.
                // If I drag folder 'A', entry.name is 'A'. Path passed should be empty at start.
                // Wait, if I drag file 'f.txt', path=''. File path should be 'f.txt'.
                // If I drag folder 'A' containing 'f.txt'. First call readEntry(A, '').
                // A is dir. Reader reads 'f.txt'. Recurse readEntry(f_entry, 'A').
                // f is file. fullPath = 'A/f.txt'.

                const fullPath = path ? `${path}/${entry.name}` : entry.name;
                result.push({ file, path: fullPath });
            } else if (entry.isDirectory) {
                const dirReader = entry.createReader();
                const entries = await new Promise((resolve, reject) => {
                    dirReader.readEntries(resolve, reject);
                });

                const newPath = path ? `${path}/${entry.name}` : entry.name;

                for (const child of entries) {
                    await readEntry(child, newPath);
                }
            }
        }

        for (const entry of entries) {
            await readEntry(entry);
        }

        return result;
    }
</script>
{% endblock %}